<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>用 podman 代替 docker | 不为人知的幻想乡</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel="shortcut icon" href=/favicon.png type=image/x-icon><link rel=icon href=/favicon.png type=image/x-icon><link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:400,700&display=swap&subset=chinese-simplified" rel=stylesheet><link href=/font/FantasqueSansMono-Regular-decl.css rel=stylesheet></head><body><nav><ul class=menu></ul><hr></nav><div class=article-meta><h1><span class=title>用 podman 代替 docker</span></h1><h2 class=date>2019/04/20</h2></div><main><p>各种容器的实现简直和 UNIX 一样乱七八糟</p><p>并且全是用 Go 写的 (???</p><p>podman 背后由 Red Hat 支持，有望成为支持各发行版自带的容器管理实现</p><p>类似的先例是 pulseaudio, systemd 和未来的 wayland</p><p>podman 目标不是容器编排，可以使用更专业的 openshift/k8s 进行容器编排</p><h3 id=使用>使用</h3><ol><li>把 <code>alias docker podman</code> 添加到你的 sh rc 文件</li></ol><h3 id=非-root-使用>非 root 使用</h3><ol><li>sysctl -w kernel.unprivileged_userns_clone=1</li><li>安装 slirp4netns ，这个程序提供 root less 时的网络命名空间</li><li>参照 subuid(5) 的提示编写你的 <code>/etc/subuid</code> 和 <code>/etc/subgid</code> 文件，这个文件提供 uid 与 gid 映射</li><li>或者按照 podman 官方的推荐运行 <code>sudo usermod --add-subuids 10000-75535 $(whoami)</code></li></ol><p>我是这样写的</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># cat /etc/subuid</span>
sa:10000:500

<span style=color:#75715e># cat /etc/subgid</span>
sa:500:50
</code></pre></div><p>标识 sa 用户可以使用从 100000 开始的 500 各 uid 和从 500 开始的 50 个 gid</p><p>非 root 用户之间的容器镜像不共享，容器镜像保存在每个用户的 <code>$XDG_DATA_HOME/.local/share/containers/storage</code> 里</p><h3 id=优点和与-docker-lxd-nspawn-等的不同>优点和与 docker lxd nspawn 等的不同</h3><ul><li><p>docker lxd podman 都是 Go 写的</p></li><li><p>podman 与 docker 都使用 runc (Go写的) 作为底层</p></li><li><p>podman 与 docker 都支持 OCI Image Fromat (Go写的)，都能使用 docker hub 上的容器镜像。
nspawn 没法使用它们的镜像</p></li><li><p>podman 使用 CNI (Go写的) 作为网络底层，实现比 Docker 网络层略微简单但原理相同。
相对于 lxd 与 nspawn CNI 可以避免编写大量的网络规则。</p></li><li><p>podman 可以使用 slirp4netns，避免打 ip a 是看到一大坨 veth* 和 docker0, 并且性能更好</p></li><li><p>podman 没有 daemon 进程，由 podman cli 直接 clone 并创建命名空间，这带来了其他好处：</p><ul><li><p>root less：可以不使用 root 运行</p></li><li><p>容器的父进程都是在终端模拟器里敲出的 podman 命令</p></li><li><p>每个用户拥有自己的 podman 命名空间，</p></li><li><p>可以用 systemd service 管理容器</p></li></ul></li><li><p>podman 里集成了 CRIU，所以 podman 里的容器可以在单机上热迁移</p></li></ul><h3 id=快速体验>快速体验</h3><h3 id=ref>ref</h3><ol><li>Replacing Docke With Podman <a href=https://media.ccc.de/v/ASG2018-177-replacing_docker_with_podman>https://media.ccc.de/v/ASG2018-177-replacing_docker_with_podman</a></li><li>CNI <a href=https://github.com/containernetworking/cni>https://github.com/containernetworking/cni</a></li><li>RunC <a href=https://github.com/opencontainers/runc>https://github.com/opencontainers/runc</a></li><li>OCI <a href=https://github.com/opencontainers/image-spec>https://github.com/opencontainers/image-spec</a></li><li>CRIU <a href=https://podman.io/blogs/2018/10/10/checkpoint-restore.html>https://podman.io/blogs/2018/10/10/checkpoint-restore.html</a></li><li>slirp4nets <a href=https://github.com/rootless-containers/slirp4netns>https://github.com/rootless-containers/slirp4netns</a></li></ol></main><footer><script type=text/x-mathjax-config>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

!function(e,n,t){for(var o,a,i,c,r,d="https://google-analytics.com/collect",s=n.hostname.split("."),l=e.cookie.match(/(^|; ?)_ga=GA1\.\d\.(\d+\.\d+)(;|$)/),h=l?l[2]:~~(2e9*Math.random())+"."+~~(Date.now()/1e3),g=s.length;g--&&(r="_ga=GA1."+(s.length-g)+"."+h,e.cookie=r+";max-age=63115200;domain="+s.slice(g).join("."),-1==e.cookie.split(/; ?/).indexOf(r)););track=((r,s,l,g,p)=>{if(o={v:1,tid:"UA-171813489-1",aip:1,cid:h,t:r,dr:e.referrer,dt:e.title,dl:n.href,ul:t.language.toLowerCase(),sr:screen.width+"x"+screen.height,vp:innerWidth+"x"+innerHeight},s&&(o.ec=s),l&&(o.ea=l),g&&(o.el=g),p&&(o.ev=p),t.sendBeacon)t.sendBeacon(d,new URLSearchParams(o));else{for(c in a=[],i=new XMLHttpRequest,o)a.push(k+"="+encodeURIComponent(o[c]));i.open("POST",d),i.send(a.join("&"))}}),track("pageview")}(document,location,navigator);
</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script></footer></body></html>